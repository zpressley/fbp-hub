# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Repository Overview

FBP Hub is a mobile-first, static web interface for the Fantasy Baseball Pantheon (FBP) league. It is built with vanilla HTML/CSS/JavaScript and served as a static site (e.g., via GitHub Pages). All dynamic content is driven by JSON files in `data/` that are typically generated by a separate pipeline (e.g., the `fbp-trade-bot` repo) and copied into this project.

The app provides:
- A homepage with standings, matchups, quick stats, and season deadlines
- A player database with search, filtering, and multiple views
- Keeper and prospect rosters by team
- WizBucks balances and an optional transaction ledger UI
- (Phase 2) Discord OAuth login + manager dashboard backed by a Cloudflare Worker

The primary documentation for the project lives in `data/README.md` and Phase 2 auth setup details in `PHASE2_SETUP.md`.

## Commands & Local Development

This repo has no Node/tooling-based build, lint, or test commands. It is a static site that can be opened directly in a browser or served by any simple HTTP server.

### Clone and run locally

- Clone and enter the repo:
  - `git clone https://github.com/<your-username>/fbp-hub.git`
  - `cd fbp-hub`
- Easiest way to view the site (no server required for basic layout):
  - On macOS: double-click `index.html` in Finder or run `open index.html`
- Recommended for realistic behavior (JSON `fetch` calls, relative paths, etc.):
  - From the repo root:
    - `python3 -m http.server 8000`
    - Visit `http://localhost:8000` in a browser
    - For auth pages, visit e.g. `http://localhost:8000/login.html`

### Data refresh workflow (with external pipeline)

The live site expects JSON payloads under `data/` (see next section). A typical workflow using the external data pipeline (e.g., `fbp-trade-bot`) is:

1. Run the data pipeline in that repo to regenerate league JSON files (players, standings, WizBucks, etc.).
2. Copy the resulting JSON outputs into this repo’s `data/` directory, overwriting existing files.
3. Commit and push changes to this repo so GitHub Pages (or your host) deploys the updated data.

Concrete example (adapted from `data/README.md`):
- In your data pipeline repo (such as `fbp-trade-bot`):
  - `python3 data_pipeline/update_all.py`
- Then from the pipeline repo:
  - `cp ../fbp-trade-bot/data/*.json ../fbp-hub/data/`
- From `fbp-hub`:
  - `git add data/`
  - `git commit -m "Update data"`
  - `git push`

There is currently no automated test suite or lint configuration in this repo as of 2025-12-27.

## Data & Configuration

### Data directory (`data/`)

All user-visible league state comes from JSON under `data/`. The core files (documented in `data/README.md`) include:
- `combined_players.json` – master list of all players and prospects (names, positions, team, manager, contract info, etc.)
- `standings.json` – current standings and this week’s matchups
- `wizbucks.json` – WizBucks balances keyed by FBP manager abbreviation
- `player_log.json` – append-only log of player transactions/events (critical for Player Log page)
- `service_stats.json` – deprecated service-time stats (no longer synced or required)
- `wizbucks_transactions.json` – optional WizBucks transaction ledger; if absent, the WizBucks UI falls back to sample/demo data

The loader in `js/main.js` uses:
- `FBPHub.config.dataPath` (default `./data/`) for local development and static hosting
- `FBPHub.config.githubRaw` as a fallback when running on GitHub Pages

If you modify data shapes, remember that multiple pages assume the structures shown in `data/README.md` (especially for `combined_players.json`, `standings.json`, and `wizbucks.json`). Any breaking change here will likely impact:
- `js/homepage.js` (standings, matchups, quick stats)
- `js/players.js` (player list, filters)
- `js/rosters.js` (keeper/prospect rosters)
- `js/wizbucks.js` (balances + ledger filters)
- `js/dashboard.js` (manager stats and WizBucks summary)

### Config directory (`config/`)

`config/` contains league-level metadata and team/manager mapping that are intended to be the single source of truth:
- `config/site.json` – league name, abbreviation, season, and UI color palette; also contains MLB and FBP service-time thresholds.
- `config/managers.json` – mapping from FBP team abbreviations to human names and Discord IDs, plus the commissioner Discord ID.

Currently most runtime logic still hard-codes some of these values inside JS (e.g., team name maps in `js/rosters.js` and `js/auth.js`). When changing team names, IDs, or season/year, keep these files and the hard-coded JS maps in sync.

## High-Level Frontend Architecture

The site is a multi-page, static frontend with shared global state and page-specific controllers.

### Global bootstrap and utilities (`js/main.js`)

- Defines the global `FBPHub` object:
  - `FBPHub.data` – in-memory copies of players, standings, WizBucks
  - `FBPHub.config` – data paths and GitHub raw URL
  - `FBPHub.cache` – last data load timestamp
- On `DOMContentLoaded`:
  - Sets up the mobile navigation (hamburger toggle + active link highlighting).
  - Loads core JSON data in parallel via `loadAllData()`.
  - Inspects the current HTML page (`getPageName()`) and dispatches to a page initializer if present on `window`.
- Exposes a set of utility functions on `window` used across other modules:
  - Date formatting (`formatDate`, `formatRelativeTime`)
  - UI helpers (`createTeamBadge`, `createPositionBadge`, `createContractBadge`)
  - Player utilities (`filterPlayers`, `getUniqueValues`)
  - Misc helpers (`debounce`, `copyToClipboard`, `showToast`)

When adding new pages, follow the existing pattern:
1. Create a new `js/<page>.js` that defines `function init<CapitalizedPageName>Page() { ... }` or a similar initializer.
2. Expose that initializer as `window.init<...>`.
3. Update the HTML to include `js/main.js` first and then your new page script.
4. Extend `initializePage()` in `js/main.js` if the new page name doesn’t already map to a case.

### Page controllers

Each major HTML page has a corresponding JS controller that assumes certain DOM IDs/classes and relies on `FBPHub.data` having been populated.

- `index.html` + `js/homepage.js`
  - Renders the home dashboard: standings table, current matchups, quick stats, and a deadline banner.
  - Uses `FBPHub.data.standings` for both standings and matchups.
  - Uses `FBPHub.data.players` and `FBPHub.data.wizbucks` for quick stats.
  - Contains a hard-coded list of key 2025 league dates for the deadline banner (prospect draft, trade window, keeper deadline, etc.); if you roll to a new season, update these dates in `displayUpcomingDeadline()`.

- `players.html` + `js/players.js`
  - Provides a searchable, filterable view of all players.
  - Uses `getUniqueValues()` from `js/main.js` to populate filters for position, team, and FBP manager.
  - Maintains page-level filter state and paginates results (50 at a time) with a “Load More” button.
  - Supports two views (card and list); both rely on `createPositionBadge`, `createContractBadge`, and `createTeamBadge` from `js/main.js`.
  - Many behaviors are tied to specific DOM IDs (`playerSearch`, `positionFilter`, `teamFilter`, `managerFilter`, `playersContainer`, etc.); keep those stable when editing markup.

- `rosters.html` + `js/rosters.js`
  - Displays team rosters, either all teams or a single selected team.
  - Uses `FBPHub.data.players` grouped by FBP manager abbreviation.
  - Supports keeper vs prospect view via `currentRosterType` and the `type` query parameter (`rosters.html?type=keepers` or `?type=prospects`).
  - Uses a `TEAM_NAMES` map in JS to render full team names; this needs to stay in sync with `config/managers.json`.
  - Computes per-team roster summaries (batters vs pitchers, prospect contract breakdowns) and groups players into logical buckets (catchers, infielders, outfielders, SP, RP).

- `wizbucks.html` + `js/wizbucks.js`
  - Shows WizBucks balances for each team and an optional historical ledger.
  - Uses `FBPHub.data.wizbucks` to build balance cards and compute totals.
  - Attempts to load `data/wizbucks_transactions.json`; if missing or failing, it generates sample transactions for demo purposes.
  - Supports filtering by manager and action type, text search, “Newest First” toggle, “Load More” pagination, and CSV export.
  - Relies heavily on DOM IDs like `balancesGrid`, `ledgerBody`, `ledgerSearch`, `transactionCount`, etc.; be careful when changing HTML structure.

- `dashboard.html` + `js/dashboard.js`
  - Protected route that requires authentication (see Auth section below).
  - Uses the authenticated user’s mapped team to:
    - Compute quick stats (current league rank and record, counts of keepers/prospects, WizBucks balance).
    - Build a roster preview for that team using `FBPHub.data.players`.
    - Wire quick actions (e.g., “View My Keepers/Prospects”) by inserting the user’s team abbreviation into roster URLs.

Other HTML pages (e.g., `login.html`, `callback.html`) are primarily auth-focused and lean on the `auth.js` module.

## Authentication & Cloudflare Worker Integration

Phase 2 adds Discord OAuth-based authentication and a personalized manager dashboard. The implementation is entirely client-side in this repo but backed by a Cloudflare Worker that holds secrets and talks to the Discord API.

### Auth configuration and mapping (`js/auth.js`)

Key pieces in `js/auth.js`:
- `AUTH_CONFIG` – OAuth configuration:
  - `clientId` – Discord application client ID (non-secret).
  - `workerUrl` – base URL for the Cloudflare Worker that performs token exchange and user lookups.
  - `redirectUri` – must match the Discord app redirect (typically `https://<github-username>.github.io/fbp-hub/callback.html`).
  - `scopes`, `sessionDuration` – scopes used and desired session length.
- `MANAGER_MAPPING` – Discord user ID → FBP team abbreviation.
- `TEAM_NAMES` – FBP team abbreviation → full name.
- `COMMISSIONER_IDS` – Discord user IDs with commissioner privileges.

When editing auth-related code:
- Keep `AUTH_CONFIG` in sync with actual Discord and Cloudflare Worker settings documented in `PHASE2_SETUP.md`.
- Update `MANAGER_MAPPING` and `TEAM_NAMES` together with any changes in `config/managers.json`.
- Be mindful that `MANAGER_MAPPING` is the canonical way the app identifies which team a logged-in user belongs to.

### AuthManager and AuthUI

`js/auth.js` defines two primary concepts:
- `AuthManager` (class, instantiated as `authManager` on `window`):
  - Tracks the current session in `localStorage` (`fbp_session`).
  - Starts the Discord OAuth flow (`login()`), handles callbacks (`handleCallback()`), and determines whether a user is authenticated or a commissioner.
  - Talks to the Cloudflare Worker at `AUTH_CONFIG.workerUrl` using `/token` and `/user` endpoints.
  - Derives the user’s FBP team via `MANAGER_MAPPING`.
- `AuthUI` (global helper):
  - Provides small rendering helpers for auth-related UI.
  - Supplies route guards like `requireAuth()` and `requireCommissioner()` used by protected pages.

On `DOMContentLoaded`, `auth.js` also injects a user menu into the navigation (avatar + logout, with optional Admin link) when a session is present.

### Auth flows

- `login.html` + `js/login.js`:
  - If a valid session exists, shows a success message and redirects the user to the dashboard.
  - Otherwise, exposes a “Continue with Discord” button that calls `authManager.login()`.
- `callback.html` + `js/callback.js`:
  - Processes the `code` and `state` query parameters from Discord.
  - Calls `authManager.handleCallback()` to exchange the code via the Cloudflare Worker, then fetches the user profile and sets the session.
  - Redirects to `dashboard.html` on success, or displays an error state.
- `dashboard.html` + `js/dashboard.js`:
  - Uses `AuthUI.requireAuth()` to ensure only authenticated users can access the page.

Cloudflare Worker code and environment variable setup are described in `PHASE2_SETUP.md`. The worker itself is not currently present in this repo; it is assumed to be configured separately in your Cloudflare account.

## Deployment Model

- The site is designed to be hosted as a static site, with GitHub Pages as the primary target.
- When configured, GitHub Pages should serve from the `main` branch and the repository root.
- Deployments are triggered by `git push` to the configured branch; there is no separate CLI deployment step in this repo.
- `data/README.md` includes an example GitHub Actions workflow (`.github/workflows/deploy.yml`) for automating data updates and commits; that workflow file is not currently present in this repo by default but can be added if you want automated daily refreshes.

## Implementation Notes & Gotchas for Agents

- **No build/test tooling**: Do not assume `npm`, `jest`, `eslint`, or similar tooling exists. Any changes should be directly in HTML/CSS/JS/JSON.
- **Data shape coupling**: Many modules depend on the exact structure of JSON files described in `data/README.md`. When changing data fields, search across `js/` for usages (e.g., `player_type`, `years_simple`, `wizbucks`, `standings.matchups`).
- **Global function wiring**: Page controllers rely on initializers being exposed on `window` and invoked from `initializePage()` in `js/main.js`. If you rename a page or its initializer, make sure to update both sides.
- **DOM ID contracts**: JS files assume specific element IDs and class names in the HTML templates. When refactoring markup (especially navigation, filters, and containers), keep these IDs or update the corresponding JS selectors.
- **Season/year values**: The season/year (“Season 13 - 2025”) is repeated in multiple HTML templates and colors in CSS. If you advance the league year, update these strings consistently and review hard-coded season-specific logic (e.g., deadline dates).
- **URL paths**: Some links in JS use relative paths (e.g., `dashboard.html`), while a few use root-relative URLs (`/dashboard.html`). On GitHub Pages, root-relative URLs resolve to the domain root, not the repository subpath, so prefer relative URLs or ensure any new links are consistent with how the site is deployed.
- **Auth backend expectations**: The frontend expects the Cloudflare Worker to expose `/token` and `/user` endpoints at `AUTH_CONFIG.workerUrl`, returning JSON in the shapes consumed by `AuthManager`. If you modify these contracts, update both the worker and `js/auth.js` together.

Keeping these invariants in mind will help avoid breaking core navigation, data loading, or authentication flows when making changes.